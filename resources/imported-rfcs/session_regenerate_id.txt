
====== PHP RFC: Make session_regenerate_id()'s delete_old_session parameter required gracefully ======
  * Version: 0.9
  * Date: 2013-10-29
  * Author: Yasuo Ohgaki <yohgaki@php.net>
  * Status: Under Discussion
  * First Published at: http://wiki.php.net/rfc/session_regenerate_id

===== Introduction =====

session_regenerate_id() is used to generate new session ID. It better to delete old session data to reduce risk of session hijack. Currently session_regenerate_id()'s delete_old_session(bool) parameter is optional and default to false which increase risk of session hijack.

===== Details =====

Old session data is better to be deleted. However, initial session_regenerate_id() implementation didn't, so 'delete_old_session'(bool) option is added later to keep compatibility back in PHP 4.x.

Session module have session data lock to keep consistency, but if there is no session data (i.e. deleted by session_regenerate_id()) lock will not work and race condition could occur. For instance, users may have multiple iframes in a page, then concurrent access from a session owner could happen as most browsers download resources concurrently. Developers can mitigate this race condition by deleting old session data later. (I have plan mitigate it in session module, but it will be proposed in different RFC.) If there is not pages that access session concurrently, users may safely set 'delete_old_session' to true.

Although session_regenerate_id(true) is recommended, but session_regenerate_id(false) has it use even if session module have race condition mitigation. Therefore, the option itself is better to be left as it is now.
===== Proposal =====

When session_regenerate_id() is called without delete_old_session parameter, raise E_DEPRECATED error with following error message.

  delete_old_session parameter is omitted. Old session data deletion is encouraged for better security.

or

  Calling session_regenerate_id() without a parameter is deprecated. Passing true is encouraged for better security

For future version (5 or 10 years later), delete_old_session parameter may be a required parameter.
===== Backward Incompatible Changes =====

None, except E_DEPRECATED is raised when parameter is omitted.

===== Proposed PHP Version(s) =====

PHP 5.6.0


===== Proposed Voting Choices =====

  * Raise E_DEPRECATED
  * Keep current behavior

===== Patches and Tests =====

  diff --git a/ext/session/session.c b/ext/session/session.c
  index 5b4820a..71ccfd0 100644
  --- a/ext/session/session.c
  +++ b/ext/session/session.c
  @@ -1958,6 +1958,10 @@ static PHP_FUNCTION(session_regenerate_id)
                  RETURN_FALSE;
          }
   
  +       if (ZEND_NUM_ARGS() == 0) {
  +               php_error_docref(NULL TSRMLS_CC, E_DEPRECATED, "delete_old_session parameter is omitted. Old session data deletion is encouraged for better security");
  +       }
  +
          if (PS(session_status) == php_session_active) {
                  if (PS(id)) {
                          if (del_ses && PS(mod)->s_destroy(&PS(mod_data), PS(id) TSRMLS_CC) == FAILURE) {
===== References =====

  * http://us3.php.net/session_regenerate_id

===== ChangeLog =====

  * 2013/10/29 - Created RFC
