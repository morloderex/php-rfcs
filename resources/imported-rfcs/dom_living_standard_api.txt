====== PHP RFC: Implement Current DOM Living Standard API ======

  * Version: 0.1
  * Date: 2019-03-13
  * Author: Benjamin Eberlei (beberlei@php.net), Thomas Weinert 
  * Status: Draft
  * First Published at: http://wiki.php.net/rfc/dom_living_standard_api

===== Introduction =====

Working with XML (HTML) documents is a necessary task for many web applications
and the dom extension implements a standardized API that was previously
specified by a w3 group into 3 DOM Levels. Since then the standard has evolved
and is now a Living Standard similar to HTML 5 and continously evolving and
maintained by the Web Hypertext Application Technology Working Group (WHATWG).

- https://dom.spec.whatwg.org

Because the new API provides much improved traversal and manipulation APIs than the old API
we propose to add the new methods to the existing ext/dom API.

Specifically we think this is a better solution to providing them in userland, because

  - ext/dom + DOMDocument represents the DOM Standard, so we should continue to support the evolving versions.
  - the added methods are a huge value add to users and fix a lot of more complicated approaches that were previously required by users. The search or re-implementation costs are high for users.

In addition this RFC seeks the approval to continue adding changes from the DOM
Living Standard without RFCs in the future as long as they are implemented in a
backwards compatible way.

===== Proposal =====

====Follow the DOM Living Standard with ext/dom====

For the first implementation step the following new interfaces are added and
implementations provided for the mentioned classes that now implement them:

<code php>
<?php
interface DOMParentNode
{
    public readonly DOMNode? $previousElementNode;
    public readonly DOMNode? $nextElementNode;
    public readonly int $childElementCount;

    public function append(...DOMNode|string|null $nodes) : void;
    public function prepend(...DOMNode|string|null $nodes) : void;
}

class DOMDocument implements DOMParentNode {}
class DOMElement implements DOMParentNode {}
class DOMDocumentFragment implements DOMParentNode {}

interface DOMChildNode
{
    public readonly DOMNode? $previousElementSibling;
    public readonly DOMNode? $nextElementSibling;

    public function remove() : void;
    public function before(...DOMNode|string|null $nodes) : void;
    public function after(...DOMNode|string|null $nodes) : void;
    public function replaceWith(...DOMNode|string|null $nodes) : void;
}

class DOMElement implements DOMChildNode {}
class DOMCharacterData implements ChildNode {}
class DOMDocumentType implements ChildNode {}
</code>

**Implementation choices:**

The standard contains an intermediate interface //DOMNonDocumentTypeChildNode//
that contains the //previousElementSibling// and //nextElementSibling// properties.
This is introduced to provide backwards compatibility with browser/web
implementations, which are not our concern. In addition PHP interfaces cannot
have properties, so it wouldn't make sense to add this empty interface. For this reason this class was not introduced, but the properties are instead on DOMChildNode directly.

The //querySelector// and //querySelectorAll// methods defined on the //DOMParentNode//
interface are omitted, because of their complexity we recommend to leave
comparable implementations of these methods to userland libraries such as
PhpCss or Symfony CSS Selector.

====Removing unimplemented classes====

The latest DOM standard removes a lot of APIs that are not strictly necessary working with XML and especially HTML in the browser.

https://dom.spec.whatwg.org/#dom-core-changes

A lot of those classes exist in ext/dom, but don't actually do anything or throw not implemented exceptions.

  * DOMConfiguration
  * DOMDomError
  * DOMErrorHandler
  * DOMImplementationList
  * DOMImplementationSource
  * DOMLocator
  * DOMObject
  * DOMUserData
  * DOMNameList
  * DOMTypeInfo
  * DOMUserDataHandler

Not only do they return "TEST" strings in property handlers, they are also mostly undocumented and there is no harm removing them.

Notable exception are DOMEntity, DOMNotation and DOMEntityReference, which are usable from DOMDocument#createEntityReference and through DOMDocumentType#entites and notations properties.

====Changing DOMImplementation::hasFeature====

The DOM Specification Level 2-3 introduced DOMImplementation::hasFeature() that were supposed to be used by clients to check for the version of a specification. The living documentation has the following to say about this:

<blockquote>hasFeature() originally would report whether the user agent claimed to support a given DOM feature, but experience proved it was not nearly as reliable or granular as simply checking whether the desired objects, attributes, or methods existed. As such, it is no longer to be used, but continues to exist (and simply returns true) so that old pages donâ€™t stop working.</blockquote>

Changing this would constitute a small BC break, given that this is probably not used by anyone. Currently DOMImplementation::hasFeature only returns true for "Core" and "1.0" (and for "XML" versions), since 2.0 and 3.0 levels were never fully implemented for ext/dom.

We propose to keep this method only returning true for hasFeature("Core", "1.0") in 7.4 and change it to always return true in PHP 8.0. 

====Changes to existing methods====

The new DOM API has a few backwards incompatible changes that would risk breaking a lot of code.

  * DOMElement::getAttribute return value changed from string to ?string. Previously non existant attributes were also empty strings.
  * DOMElement->nodeName casing was previously undefined, it is now changed to always uppercase.

We propose to add a compatibility layer with flags that allows users to control to the behavior of these for each document:

<code php>
<?php

$document = new DOMDocument();
$document->compatibility = DOM_COMPATIBILITY_UPPERCASE_NODENAME | 
    DOM_COMPATIBILITY_GET_ATTRIBUTE_NULL;

// DOM_COMPATIBILITY_ALL would be all flags that the current ext/dom version supports.
</code>

===== Backward Incompatible Changes =====

No BC Breaks, except removing the classes that are undocumented, unimplemented and contain dummy data.

===== Proposed PHP Version(s) =====

PHP 7.4, DOMImplementation::hasFeature() change to always true in PHP 8.0

===== RFC Impact =====

==== To SAPIs ====

No effect on SAPIs.

==== To Existing Extensions ====

The dom extensions API is changed in a backwards compatible way.

The new functionality can all be implemented entirely using the already available libxml2 datastructures.

==== To Opcache ====

No effect on Opcache.

===== Future Scope =====

In the future this RFC seeks approval to add more functionality of the DOM Living Standard to ext/dom
as long as no backwards incompatible changes are introduced.

The CSS query selector APIs could be added in a future version by introducing a new interface:

<code php>
interface DOMQuerySelector
{
    public function querySelector($selector) : ?DOMNode;
    public function querySelectorAll($selector) : DOMNodeList
}
</code>
    
This is unlikely though, the complexity for this is very high, because it requires a CSS parser plus the benefit is lower because there are already good userland solutions available that convert CSS Level 4 queries into xpath.

===== Patches and Tests =====

https://github.com/beberlei/php-src/pull/1

This pull request is still work in progress. 

===== Implementation =====

tbd

===== References =====

- DOM Living Standard Document https://dom.spec.whatwg.org
