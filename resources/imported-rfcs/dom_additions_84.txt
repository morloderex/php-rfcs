====== PHP RFC: New ext-dom features in PHP 8.4 ======
  * Version: 0.1
  * Date: 2024-04-12
  * Author: Niels Dossche, <nielsdos@php.net>
  * Status: Draft
  * First Published at: http://wiki.php.net/rfc/dom_additions_84

===== Introduction =====

The PHP 8.4 development cycle has seen two major improvements to the ext-dom extension already: [[rfc::domdocument_html5_parser|HTML 5 support]], and [[rfc:opt_in_dom_spec_compliance|opt-in spec compliance]]. This RFC is the final improvement to ext-dom for PHP 8.4: it proposes to add new features to the extension. In particular, we'll be focussing on CSS selector support, filling in feature holes, and adding new properties.

===== Proposal =====

The proposal consists of multiple sub-proposals bundled together under one RFC to minimize overhead.
In this section, we'll discuss each feature separately.

==== CSS selectors ====

==== $innerHTML ====

==== New properties for Document ====

I propose the additional of several new properties for the Document class to make developing a bit easier:

<PHP>
class Document {
        /* existing stuff */

        public ?HTMLElement $body;
        /** @readonly */
        public ?HTMLElement $head;
        public string $title;
}
</PHP>

These additions are described in the HTML addendum for the DOM specification in https://html.spec.whatwg.org/#document.

The properties should be relatively self-explanatory. <php>$body</php> refers to the body element (if there is one), <php>$head</php> to the head element, and <php>$title</php> to the text inside the title element (which in turn is inside the head element). You can read about all the details using the link above, because it's a bit more complicated when SVG is involved for example, but you should be familiar with these properties from Javascript.

As you can see, this requires adding the HTMLElement class as well. This class extends the Element class. In the future we may add properties on them too but this is left out of this RFC for now.
Elements that are within the HTML namespace will now return an instance of HTMLElement instead of Element. For example, <php>$documentElement</php> is a property on the Document class of type Element. If this is an HTML element, we will get an instance of HTMLElement instead of Element. This is all as defined in the spec.

==== TokenList ====

==== PHP-specific additions ====

==== Allowing PHP-specific developer experience improvements ====

DOM functions like <php>Element::insertAdjacentElement(string $where, Element $element)</php> and <php>Element::insertAdjacentText(string $where, string $data)</php> have a first "where" argument. There are only four valid values for "where": "beforebegin", "afterbegin", "beforeend", "afterend". So that's actually an enum in disguise. I propose to make use of the PHP enum feature. This would prevent programming mistakes and make IDE hints much nicer, contributing to a better developer experience. Strictly speaking, this deviates from the DOM spec, but we already model the DOM classes in a way that fits PHP's OOP model. In fact, I'd propose to allow the use of enums where it makes sense in the extension for new APIs. Since the Element class didn't exist prior to the opt-in spec compliance RFC, we can change the signature without affecting users as no releases of PHP 8.4 have been made so far.

In particular, this will result in the following enum and function signatures:
<PHP>
namespace DOM {
  enum AdjacentPosition {
    BeforeBegin,
    AfterBegin,
    BeforeEnd,
    AfterEnd,
  }

  Element::insertAdjacentElement(string $where, Element $element): ?Element;
  Element::insertAdjacentText(string $where, string $data): void;
}
</PHP>

==== API amendments ====

Initially, the [[rfc:opt_in_dom_spec_compliance|DOM spec-compliance RFC]] copied the existing APIs from the old DOM classes without a deviation for most APIs. Someone reported that the <php>(DOM)Document::xinclude()</php> has weird return value behaviour. In particular, quoting from the documentation:
<blockquote>Returns the number of XIncludes in the document, -1 if some processing failed, or false if there were no substitutions. </blockquote>
This seems to be caused by an implementation mistake. The more sensical behaviour would be to return false on failure, and the number of substitutions on success. If there were no substitutions the number 0 should be returned. I propose to make this change to the new classes.

===== Backward Incompatible Changes =====

None because this RFC only affects classes added in 8.4.

===== Proposed PHP Version(s) =====

PHP 8.4.

===== RFC Impact =====

==== To Existing Extensions ====

Only ext-dom is affected.

===== Open Issues =====

None yet.

===== Unaffected PHP Functionality =====

Everything outside ext-dom.

===== Future Scope =====

I initially planned on including the outerHTML property too. This is very feasible with all the internal DOM work that happened during the PHP 8.4 development cycle. However, given that I haven't seen demand for this, I think my time is better spent with other features. If someone really wants this in 8.4, feel free to make a PoC implementation, should be fairly doable using Lexbor and the current ext-dom internal APIs.

===== Proposed Voting Choices =====

One primary yes/no vote requiring 2/3rd majority: "Accept this proposal?".

===== Patches and Tests =====
Links to any external patches and tests go here.

If there is no patch, make it clear who will create a patch, or whether a volunteer to help with implementation is needed.

Make it clear if the patch is intended to be the final patch, or is just a prototype.

For changes affecting the core language, you should also provide a patch for the language specification.

===== Implementation =====
After the project is implemented, this section should contain 
  - the version(s) it was merged into
  - a link to the git commit(s)
  - a link to the PHP manual entry for the feature
  - a link to the language specification section (if any)

===== References =====
Links to external references, discussions or RFCs
