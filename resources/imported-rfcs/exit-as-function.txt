====== PHP RFC: Transform exit() from a language construct into a standard function ======

  * Version: 0.2
  * Date: 2024-05-05
  * Author: Gina Peter Banyard <girgias@php.net>
  * Status: Under Discussion
  * Target Version: PHP 8.4
  * Implementation: <https://github.com/php/php-src/pull/13483>
  * First Published at: <http://wiki.php.net/rfc/exit-as-function>

===== Introduction =====

The <php>exit</php> language construct (and its alias <php>die</php>) can be used on its own without parentheses 
((which is somewhat akin to using a constant as it can be used in expressions: https://3v4l.org/sL9Q5))
to terminate a PHP script with status code <php>0</php>, or it can be used like a "function" which accepts an
optional argument <php>$status</php> that can either be an integer, in which case the PHP script will be terminated
with the given integer as the status code, or it can be a string, in which case the PHP script is terminated
with status code <php>0</php> and the string is printed to STDOUT.

However, because <php>exit()</php> is not a proper function it cannot be called with a named argument,
passed to functions as a <php>callable</php>, does not respect the <php>strict_types</php> declare,
and most confusingly, it does not follow the usual type juggling semantics.

Indeed, any value which is //not// an integer, is cast to a string.
This means passing an array or a resource to <php>exit()</php> will not throw a <php>TypeError</php>
but print <php>Array</php> or <php>Resource id #%d</php> respectively with the relevant warning being emitted.
However, it does throw a <php>TypeError</php> for non-<php>Stringable</php> objects.

Furthermore, arguments of type <php>bool</php> are cast to <php>string</php> instead of <php>int</php>, violating the standard type juggling semantics
for a <php>string|int</php> union type. This is something that we find especially confusing for CLI scripts which may have a
boolean <php>$has_error</php> variable passed to <php>exit()</php> with the assumption that <php>false</php> will be coerced to <php>0</php>
and <php>true</php> coerced to <php>1</php>.

Since PHP 8.0 <php>exit()</php> doesn't use the bailout mechanism anymore,
but throws a special kind of exception which cannot be caught,
and which does not execute <php>finally</php> blocks. ((https://github.com/php/php-src/pull/5768))

Finally, there didn't seem to ever have been a necessity for <php>exit()</php> to be its own dedicated opcode.

===== Proposal =====

We propose to make <php>exit()</php> a proper function with the following signature:
<PHP>
function exit(string|int $status = 0): never {}
</PHP>

Parsing of the keywords remains unchanged, but instead of being compiled to a <php>ZEND_EXIT</php> opcode they are compiled to
a function call.

Therefore, it will remain impossible to declare functions named <php>exit</php> or <php>die</php> in namespaces,
or to disable/remove them via the <php>disable_functions</php> INI directive.

===== Backward Incompatible Changes =====

The impact of this RFC is deemed to be low.

The behaviour of values of different types passed to <php>exit()</php> will be altered to match the usual type juggling semantics:

| Argument passed       | Current behaviour | New behaviour | Consequences                                                                                                                         |
|-----------------------|-------------------|---------------|--------------------------------------------------------------------------------------------------------------------------------------|
| int                   | int               | int           | No change, interpreted as exit code                                                                                                  |
| string                | string            | string        | No change, interpreted as status message                                                                                             |
| bool                  | string            | int           | Was status message, now exit code                                                                                                    |
| float                 | string            | int           | Was status message, now exit code, with a possible <php>"Implicit conversion from float to int loses precision"</php> deprecation notice        |
| null                  | string            | int           | Was status message, now exit code, with <php>"Passing null to parameter #1 ($status) of type string|int is deprecated"</php> deprecation notice |
| stringable object     | string            | string        | No change, interpreted as status message                                                                                             |
| non-stringable object | TypeError         | TypeError     | None                                                                                                                                 |
| array                 | string            | TypeError     | Was status message with warning, now TypeError                                                                                       |
| resource              | string            | TypeError     | Was status message with warning, now TypeError                                                                                       |


===== Future scope =====

These are ideas for future proposals that are //not// part of this RFC:

  * Deprecate using <php>exit</php> without parentheses
  * Execute <php>finally</php> blocks when <php>exit</php> is called
  * Allow disabling <php>exit()</php>/<php>die()</php> functions via the <php>disable_functions</php> INI directive, similarly to how it is possible to disable <php>assert()</php>


===== Version =====

Next minor version, PHP 8.4.

===== Vote =====

As per the voting RFC a yes/no vote with a 2/3 majority is needed for this proposal to be accepted.

Voting started on 2024-07-30 and will end on 2024-08-13.
 
<doodle title="Accept Transform exit() from a language construct into a standard function RFC?" auth="girgias" voteType="single" closed="false">
   * Yes
   * No
</doodle>

===== Changelog =====

In a prior version of this RFC the <php>T_EXIT</php> token was removed.

===== Notes =====
