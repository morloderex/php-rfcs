====== PHP RFC: -> in const expressions ======
  * Date: 2022-05-27
  * Author: Ilija Tovilo <ilutov@php.net>
  * Status: Draft
  * Proposed Version: PHP 8.2
  * Implementation: https://github.com/php/php-src/pull/8625

===== Introduction =====

This RFC proposes to allow use of ''->'' in constant expressions. The primary motivation for this change is to allow fetching the ''name'' and ''value'' properties of enums in places where enum objects aren't allowed, like array keys (see https://github.com/php/php-src/issues/8344).

<PHP>
enum A: string {
    case B = 'B';
    // This is currently not permitted
    const C = [self::B->value => self::B];
}
</PHP>

There is currently no way to express this without repeating the value of the enum case.

This RFC proposes to relax this restriction and allow the use of ''->'' inside of constant expressions.

===== Proposal =====

This RFC proposes to allow the use of ''->'' inside all constant expressions. As ''->'' may only be used on objects there are two scenarios where ''->'' can be used:

  * Enums (for the ''name'' and ''value'' properties)
  * ''new'' (for any declared property or magic ''__get'')

Here are a few examples of code that will become valid if this RFC is accepted:

<PHP>
// Where E::B is a unit enum
const A = E::B->name;

// Where E::C is a backed enum
function a() {
    static $b = E::C->value;
}

// Where B is a class with a property $c
#[A((new B)->c)]
class D {}

// Where C::$d is an object with a property $e
function a(
    $b = (new C)->d->e
) {}

// The rhs of -> allows other constant expressions
const A = 'foo';
const B = (new C)->{A};
</PHP>

The behavior is identical to ''->'' outside of constant expressions, including access on non-object warnings, undefined property warnings, etc.

===== Backward Incompatible Changes =====

There are no backwards-incompatible changes in this RFC.

===== Alternative approaches =====

Alternatively, arrays could be extended to allow enums or all objects as keys. This is the approach of the [[https://wiki.php.net/rfc/object_keys_in_arrays|object keys in arrays RFC]]. While this RFC still might be worthwhile it comes with significant API changes in the engine and it does break the assumption in userland code that array keys are of type ''int|string''.

===== Terminology =====

Note that the term "constant expression" in this RFC refers to any expression that isn't directly compiled to OpCodes but instead stored as a constant AST which is evaluated at run-time. Since allowing ''new'' in these expressions the result is no longer guaranteed to be pure or constant.

===== Vote =====

Voting opened on xxx and closes on xxx.

<doodle title="Add support for fetching properties in constant expressions?" auth="ilutov" voteType="single" closed="true">
   * Yes
   * No
</doodle>
